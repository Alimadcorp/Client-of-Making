<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Authentication</title>

        <link rel="stylesheet" href="/public/style.css">
        <link rel="stylesheet" href="style.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=National+Park:wght@200..800&display=swap" rel="stylesheet">
    </head>
    <body>
        <h1 class="heading">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M20.5605 22.9395C21.147 23.5245 21.147 24.4755 20.5605 25.0605L14.5605 31.0605C13.9755 31.647 13.0245 31.647 12.4395 31.0605C11.853 30.4755 11.853 29.5245 12.4395 28.9395L15.879 25.5H4.5C3.672 25.5 3 24.828 3 24C3 23.172 3.672 22.5 4.5 22.5H15.879L12.4395 19.0605C11.853 18.4755 11.853 17.5245 12.4395 16.9395C13.0245 16.353 13.9755 16.353 14.5605 16.9395L20.5605 22.9395Z" fill="var(--text)"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M29.826 12H29.8245C27.2745 11.9985 25.5345 12.0675 24.1695 12.375C24.162 12.3765 24.1545 12.378 24.147 12.3795C22.962 12.639 22.491 12.993 22.209 13.3365V13.338C21.864 13.761 21.462 14.589 21.1905 16.4025V16.407C21.18 16.479 21.168 16.5525 21.1575 16.6275C21.0495 17.4015 20.406 18 19.6245 18C18.7485 18 18.051 17.2485 18.165 16.38C19.014 9.882 21.774 9 29.8245 9C40.3245 9 41.8245 10.5 41.8245 24C41.8245 37.5 40.3245 39 29.8245 39C21.774 39 19.014 38.118 18.165 31.62C18.051 30.7515 18.7485 30 19.6245 30C20.406 30 21.0495 30.5985 21.1575 31.3725C21.168 31.4475 21.18 31.521 21.1905 31.593V31.5975C21.462 33.411 21.864 34.2405 22.209 34.6635C22.491 35.007 22.962 35.361 24.147 35.6205C24.1545 35.622 24.162 35.6235 24.1695 35.625C25.5345 35.931 27.2745 36 29.8245 36H29.826C32.376 36 34.116 35.931 35.481 35.625C35.4885 35.6235 35.496 35.622 35.5035 35.6205C36.6885 35.361 37.1595 35.007 37.44 34.6635H37.4415C37.7865 34.2405 38.1885 33.411 38.4585 31.599C38.4585 31.599 38.46 31.5945 38.46 31.5915C38.7435 29.721 38.826 27.3195 38.8245 24C38.826 20.6805 38.7435 18.279 38.46 16.4085C38.46 16.4055 38.4585 16.401 38.4585 16.401C38.1885 14.589 37.7865 13.761 37.4415 13.338L37.44 13.3365C37.1595 12.993 36.6885 12.639 35.5035 12.3795C35.496 12.378 35.4885 12.3765 35.481 12.375C34.116 12.0675 32.376 11.9985 29.826 12Z" fill="var(--text)"/>
            </svg>
            Login
        </h1>
        
        <textarea id="tokenInput" placeholder="ahoy_visitor=...; _journey_session=..."></textarea>
        <button onclick="saveToken()" class="save__button">
            <svg width="20" height="20" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M24 12C27.714 12 30.111 12.3135 31.707 12.858C32.328 13.0695 33.036 12.972 33.4995 12.507L34.263 11.745C34.596 11.412 34.542 10.8555 34.125 10.6365C31.8345 9.435 28.569 9 24 9C12 9 9 12 9 24C9 36 12 39 24 39C36 39 39 36 39 24C39 23.481 38.994 22.98 38.982 22.494C38.967 21.8475 38.193 21.5505 37.7355 22.008L36.441 23.301C36.159 23.5845 36 23.967 36.0045 24.3675C36.0345 27.411 36.1155 31.6425 33.879 33.879C32.583 35.175 30.021 36 24 36C17.979 36 15.417 35.175 14.121 33.879C12.825 32.583 12 30.021 12 24C12 17.979 12.825 15.417 14.121 14.121C15.417 12.825 17.979 12 24 12Z" fill="black"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M16.0605 21.4395C15.4755 22.0245 15.4755 22.9755 16.0605 23.5605L22.9395 30.4395C23.5245 31.0245 24.4755 31.0245 25.0605 30.4395L42.4395 13.0605C43.0245 12.4755 43.0245 11.5245 42.4395 10.9395L41.9355 10.4355C41.3505 9.85052 40.3995 9.85052 39.8145 10.4355L24 26.25L18.6855 20.9355C18.1005 20.3505 17.1495 20.3505 16.5645 20.9355L16.0605 21.4395Z" fill="black"/>
            </svg>
            Save
        </button>

        <p id="status"></p>

        <script>
        async function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const status = document.getElementById('status');

            if (!token) {
                alert('entr ur token mate');
                return;
            }

            status.textContent = 'Validating token...';
            localStorage.setItem('som_token', token);

            try {
                const res = await fetch('/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cookie: token, path: '/campfire' })
                });

                if (!res.ok) {
                    status.textContent = `nu uh. server told me: ${res.status}`;
                    console.log("Validation failed. Server status:", res.status);
                    return;
                }

                const data = await res.json();

                const time = data?.extractedData?.todayCodingTime?.trim();

                if (data.status === 'success' && time && /\d+h/.test(time)) {
                    status.textContent = 'token is valid <3 redirecting...';
                    setTimeout(() => {
                        window.location.pathname = '/testing';
                    }, 200);
                } else {
                    status.textContent = 'ðŸ’€ ur token is invalid / expired. pls try again in one minute and actually watch the video tutorial';
                    console.log('Invalid or expired token. Received:', data);
                }
            } catch (err) {
                console.error("oop; server said:", err);
                status.textContent = 'We couldn\'t validate your token due to a network or server error.';
            }
        }
        </script>
    </body>
</html>