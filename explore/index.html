<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>COM - Explore</title>

        <link rel="stylesheet" href="/public/style.css">
        <link rel="stylesheet" href="style.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=National+Park:wght@200..800&display=swap" rel="stylesheet">

        <script src="/public/tokenRequired.js"></script>
    </head>
    <body>
        <div class="layout-container">
            <div class="sidebar regular-glassmorphism">
                <div class="sidebar__campfire" onclick="window.location.pathname = '/campfire/'">
                    <svg width="32" height="32" viewBox="0 0 97 122" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M88.7619 78.9755C90.2137 78.4562 91.8092 78.5116 93.2215 79.1304C94.6338 79.7492 95.756 80.8846 96.3584 82.304C96.9607 83.7234 96.9976 85.3193 96.4614 86.765C95.9252 88.2107 94.8566 89.3967 93.4744 90.0801L92.8219 90.358L66.4621 99.7709L92.8219 109.184C94.2807 109.696 95.4875 110.749 96.1937 112.124C96.9 113.5 97.052 115.094 96.6184 116.578C96.1848 118.062 95.1987 119.324 93.8631 120.103C92.5274 120.882 90.9439 121.119 89.4386 120.766L88.7619 120.566L48.5002 106.187L8.23856 120.566C6.78673 121.086 5.19128 121.03 3.77899 120.411C2.3667 119.793 1.24445 118.657 0.642093 117.238C0.03974 115.818 0.00287299 114.222 0.539044 112.777C1.07521 111.331 2.14385 110.145 3.52606 109.462L4.17856 109.184L30.5384 99.7709L4.17856 90.358C2.71974 89.8454 1.51297 88.793 0.806713 87.4175C0.100453 86.042 -0.0515371 84.448 0.382035 82.9638C0.815607 81.4796 1.80174 80.2181 3.13739 79.4391C4.47305 78.6601 6.05656 78.4228 7.56189 78.7761L8.23856 78.9755L48.5002 93.3546L88.7619 78.9755ZM43.8481 5.47257L48.1196 2.6934L49.4488 1.88986C52.4092 0.216319 55.6717 -0.889307 58.4931 1.56361C60.1848 3.02569 60.7467 5.0859 60.4446 7.18236L60.2029 8.4209L60.1123 9.26674C60.0821 9.77424 60.0821 10.4086 60.1606 11.1215C60.6802 15.7797 63.8521 19.1086 67.1388 22.1234L69.8998 24.6367L71.9661 26.5882C76.8719 31.3732 82.2852 37.8257 84.5629 46.9486C87.3059 57.9082 84.5992 67.738 77.4217 74.6617C70.4979 81.3559 60.1063 84.6667 48.5002 84.6667C29.3542 84.6667 12.2502 72.2692 12.2502 51.4376C12.2502 35.1492 23.0165 22.2865 32.4415 14.0397C36.0567 10.9379 39.8712 8.07609 43.8602 5.47257M49.8415 43.9701L48.5002 42.3751L47.165 43.9701L45.7331 45.7886L44.6033 47.3111L43.395 49.0269C40.0963 53.8542 36.4169 60.4819 36.4169 66.0403C36.4169 72.9882 41.8302 78.6251 48.5002 78.6251C55.1763 78.6251 60.5836 72.9882 60.5836 66.0403C60.5836 60.4819 56.9042 53.8542 53.6054 49.0269L52.3971 47.3111L51.2673 45.7886L49.8415 43.9701Z" fill="#4A2D24"></path>
                    </svg>
                </div>
                <div class="sidebar__explore" onclick="window.location.pathname = '/explore/'">  
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 0C31.046 0 40 8.954 40 20C40 31.046 31.046 40 20 40C8.954 40 0 31.046 0 20C0 8.954 8.954 0 20 0ZM28.486 11.514C27.778 10.808 18.586 12.928 15.758 15.758C12.93 18.586 10.808 27.778 11.514 28.486C12.222 29.192 21.414 27.072 24.242 24.242C27.072 21.414 29.192 12.222 28.486 11.514ZM20 18C20.5304 18 21.0391 18.2107 21.4142 18.5858C21.7893 18.9609 22 19.4696 22 20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22C19.4696 22 18.9609 21.7893 18.5858 21.4142C18.2107 21.0391 18 20.5304 18 20C18 19.4696 18.2107 18.9609 18.5858 18.5858C18.9609 18.2107 19.4696 18 20 18Z" fill="#4A2D24"></path>
                    </svg>
                </div>
            </div>
            <div class="main-area regular-glassmorphism">
                <div class="main-area__status-div">
                    <img id="main-area__status-image" width="128" height="auto">
                    <p id="main-area__status"></p>
                </div>

                <div class="main-area__section">
                    <div class="cache__notice regular-glassmorphism">
                        <img height="75" width="auto" id="happy-dino">
                        <div style="display: flex; flex-direction: column;">
                            <h2>We're doing our part!</h2>
                            <p>We cache your explore requests for 10 minutes to prevent slowing down Summer of Making!</p>
                        </div>
                    </div>
                    <div class="filters__div">
                        <select id="filter__category" class="regular-glassmorphism">
                            <input type="text" id="search__input" placeholder="searchy me projects..." class="search-input regular-glassmorphism">
                        </select>
                    </div>
                    <div class="projects-grid">

                    </div>
                    <button id="load-more-btn" class="load-more-btn">Load More</button>
                </div>
            </div>
        </div>
        
        <script>
            let allProjects = [];
            let filteredProjects = [];
            let currentOffset = 0;
            let searchQuery = '';
            const slackNameCache = {};
            const slackPfpCache = {};
            const PROJECTS_PER_PAGE = 48;

            document.getElementById('search__input').addEventListener('input', e => {
                searchQuery = e.target.value.toLowerCase();
                applyFilters();
            });

            const getCreatorFromRepo = (repoLink) => {
                try {
                    const match = new URL(repoLink).pathname.split('/')[1];
                    return match || 'Unknown';
                } catch {
                    return 'Unknown';
                }
            };
        
            async function fetchPage() {
                const cookie = getToken();
                const path = "/explore";
            
                const statusDiv = document.querySelector('.main-area__status-div');
                const status = document.getElementById('main-area__status');
                const statusImage = document.getElementById('main-area__status-image');
                statusDiv.classList.add('centeredHV');
                status.textContent = "Pending SOM backend request!";
                statusImage.src = "/public/orpheus/waaaah_dino.png";
            
                try {
                    const res = await fetch('/fetch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cookie, path })
                    });
                
                    const text = await res.text();
                    const parsedResponse = JSON.parse(text);
                
                    const extractedData = parsedResponse?.extractedData;
                    const projects = extractedData?.rawProjects;
                
                    if (!Array.isArray(projects)) throw new Error("Invalid projects data");
                
                    allProjects = projects;
                    filteredProjects = [...allProjects];
                    statusDiv.remove();
                
                    populateCategoryDropdown(allProjects);
                    renderProjects();
                } catch (err) {
                    statusImage.src = "/public/orpheus/man_face_dino.png";
                    status.textContent = err.message;
                    console.error("Error fetching or rendering projects:", err);
                }
            }
        
            function populateCategoryDropdown(projects) {
                const dropdown = document.getElementById('filter__category');
                dropdown.innerHTML = '<option value="all">All Categories</option>';
            
                const categories = [...new Set(projects.map(p => p.category).filter(Boolean))].sort();
                for (const category of categories) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    dropdown.appendChild(option);
                }
            
                dropdown.addEventListener('change', () => {
                    applyFilters();
                });
            }
        
            function renderProjects() {
                currentOffset = 0;
                document.querySelector('.projects-grid').innerHTML = '';
                document.getElementById('load-more-btn').style.display = 'block';
                renderNextBatch();
            }
        
            function renderNextBatch() {
                const grid = document.querySelector('.projects-grid');
                const next = filteredProjects.slice(currentOffset, currentOffset + PROJECTS_PER_PAGE);
            
                for (const project of next) {
                    const card = document.createElement('div');
                    card.classList.add('project-card', 'regular-glassmorphism');
                
                    const banner = document.createElement('img');
                    banner.classList.add('project-card__banner');
                    const fallback = "/public/banner-placeholder.png";
                
                    getBannerUrl(project.id).then(url => {
                        banner.src = url || fallback;
                        banner.alt = `${project.title} Banner`;
                    });
                
                    card.appendChild(banner);
                    
                    let creator = project.creator_name || getCreatorFromRepo(project.repo_link) || '?';

                    const title = document.createElement('h3');
                    title.classList.add('project-card__title');
                    title.innerHTML = `${project.title} <span class="project-card__creator">by ${creator || '?'}</span>`;
                    card.appendChild(title);

                    if (project.slack_id && !project.creator_name) {
                        const span = title.querySelector('.project-card__creator');
                        if (slackNameCache[project.slack_id]) {
                            project.creator_name = slackNameCache[project.slack_id];
                            span.textContent = `by ${slackNameCache[project.slack_id]}`;
                        } else {
                            fetch(`/slack/user/${project.slack_id}`)
                                .then(res => res.json())
                                .then(data => {
                                    if (data.name) {
                                        slackNameCache[project.slack_id]
                                        project.creator_name = data.name;
                                        span.textContent = `by ${data.name}`;
                                    }
                                    if (data.image_24) {
                                        project.creator_name = data.name;
                                        span.innerHTML = `by <img src="${data.image_24}" width="19" height="19"> ${data.name}`;
                                    }
                                })
                                .catch(err => console.error('Failed to fetch Slack user:', err));
                        }
                    }
                
                    const desc = document.createElement('p');
                    desc.classList.add('project-card__description');
                    desc.textContent = project.description;
                    card.appendChild(desc);
                
                    if (project.category) {
                        const cat = document.createElement('p');
                        cat.classList.add('project-card__category');
                        cat.innerHTML = `<svg width="18" height="18" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 16.5C10.5 16.1022 10.658 15.7206 10.9393 15.4393C11.2206 15.158 11.6022 15 12 15H36C36.3978 15 36.7794 15.158 37.0607 15.4393C37.342 15.7206 37.5 16.1022 37.5 16.5C37.5 16.8978 37.342 17.2794 37.0607 17.5607C36.7794 17.842 36.3978 18 36 18H12C11.6022 18 11.2206 17.842 10.9393 17.5607C10.658 17.2794 10.5 16.8978 10.5 16.5ZM15 24C15 23.6022 15.158 23.2206 15.4393 22.9393C15.7206 22.658 16.1022 22.5 16.5 22.5H31.5C31.8978 22.5 32.2794 22.658 32.5607 22.9393C32.842 23.2206 33 23.6022 33 24C33 24.3978 32.842 24.7794 32.5607 25.0607C32.2794 25.342 31.8978 25.5 31.5 25.5H16.5C16.1022 25.5 15.7206 25.342 15.4393 25.0607C15.158 24.7794 15 24.3978 15 24ZM19.5 31.5C19.5 31.1022 19.658 30.7206 19.9393 30.4393C20.2206 30.158 20.6022 30 21 30H27C27.3978 30 27.7794 30.158 28.0607 30.4393C28.342 30.7206 28.5 31.1022 28.5 31.5C28.5 31.8978 28.342 32.2794 28.0607 32.5607C27.7794 32.842 27.3978 33 27 33H21C20.6022 33 20.2206 32.842 19.9393 32.5607C19.658 32.2794 19.5 31.8978 19.5 31.5Z" fill="#777"/></svg> ${project.category}`;
                        card.appendChild(cat);
                    }
                
                    const links = document.createElement('div');
                    links.classList.add('project-card__links');
                
                    if (project.repo_link) {
                        const a = document.createElement('a');
                        a.href = project.repo_link;
                        a.target = '_blank';
                        a.textContent = 'GitHub Repo';
                        links.appendChild(a);
                    }
                
                    if (project.demo_link) {
                        const a = document.createElement('a');
                        a.href = project.demo_link;
                        a.target = '_blank';
                        a.textContent = 'Demo';
                        links.appendChild(a);
                    }
                
                    if (project.readme_link) {
                        const a = document.createElement('a');
                        a.href = project.readme_link;
                        a.target = '_blank';
                        a.textContent = 'README';
                        links.appendChild(a);
                    }
                
                    if (links.children.length > 0) {
                        card.appendChild(links);
                    }
                
                    grid.appendChild(card);
                }
            
                currentOffset += next.length;
            
                if (currentOffset >= filteredProjects.length) {
                    document.getElementById('load-more-btn').style.display = 'none';
                }
            }
        
            async function getBannerUrl(projectId) {
                try {
                    const res = await fetch(`/project-banner/${projectId}`);
                    const data = await res.json();
                    return data.url || null;
                } catch {
                    return null;
                }
            }

            function applyFilters() {
                const selectedCategory = document.getElementById('filter__category').value;

                filteredProjects = allProjects.filter(p => {
                    const matchesCategory = selectedCategory === 'all' || p.category === selectedCategory;
                    const matchesSearch = searchQuery === '' ||
                        (p.title && p.title.toLowerCase().includes(searchQuery)) ||
                        (p.description && p.description.toLowerCase().includes(searchQuery)) ||
                        (p.creator_name && p.creator_name.toLowerCase().includes(searchQuery));
                    return matchesCategory && matchesSearch;
                });

                currentOffset = 0;
                document.querySelector('.projects-grid').innerHTML = '';
                document.getElementById('load-more-btn').style.display = 'block';
                renderNextBatch();
            }
        
            window.addEventListener('DOMContentLoaded', () => {
                fetchPage();
                document.getElementById('load-more-btn').addEventListener('click', renderNextBatch);
            
                const dinoImages = [
                    '/public/orpheus/party_dino.gif',
                    '/public/orpheus/chill_dino.png',
                    '/public/orpheus/party_orpheus.png',
                    '/public/orpheus/nervous_dino.gif'
                ];
                const randomIndex = Math.floor(Math.random() * dinoImages.length);
                document.getElementById('happy-dino').src = dinoImages[randomIndex];
            });
        </script>
    </body>
</html>